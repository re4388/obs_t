# 在程式碼審查中要注意的事項 (What to look for in a code review)

注意：在考量這些點時，請務必考慮[程式碼審查標準](https://eng-practices.gh.miniasp.com/review/reviewer/standard.html)。


## 設計 (Design)[](https://eng-practices.gh.miniasp.com/review/reviewer/looking-for.html#%E8%A8%AD%E8%A8%88-design)

在回顧中需要重點涵蓋的是變更清單的整體設計。變更清單中各個程式碼部分間的互動是否有意義？這種變更應該屬於您的程式碼庫還是函式庫？它是否與系統的其餘部分良好整合？此功能現在新增是否恰當？


## 功能 (Functionality)[](https://eng-practices.gh.miniasp.com/review/reviewer/looking-for.html#%E5%8A%9F%E8%83%BD-functionality)

這個變更清單 (CL) 是否符合開發人員的意圖？開發人員意圖的內容是否對這段程式碼的使用者有益？「使用者」通常指最終使用者 (當他們受到變更影響時) 和開發人員 (將來必須「使用」此程式碼的人)。


通常，我們期望開發人員在程式碼測試完成後再進行程式碼審查。然而，作為審查者，你仍應該考慮邊緣情況、尋找並發問題、以用戶的角度思考，且確保在讀取程式碼時並未發現任何錯誤。


如果需要的話，您可以驗證變更清單（CL） - 當 CL 產生使用者端影響（例如 UI 變更）時，審查者檢查 CL 行為是最重要的時候。當您只是閱讀程式碼時，很難理解一些變更會如何影響使用者。對於這樣的更改，如果在 CL 中套用和自行測試太麻煩，您可以要求開發人員向您展示功能的示範。


另一個需要在程式碼審查中特別考慮功能性的時間是，如果在 CL 中存在某種**並行程式設計**，理論上可能會導致死鎖或競態條件。這些問題通常很難僅透過運行程式碼就檢測到，通常需要開發人員和審查人員仔細思考，以確保沒有引入問題。(請注意，這也是不使用可能存在競態條件或死鎖的並發模型的一個很好的理由 - 它可能會使程式碼審查或理解程式碼變得非常複雜。)


## 複雜度 (Complexity)[](https://eng-practices.gh.miniasp.com/review/reviewer/looking-for.html#%E8%A4%87%E9%9B%9C%E5%BA%A6-complexity)

變更清單是否比它應該的複雜？在每個層面上檢查，逐行檢查是否太複雜？函式是否太複雜？類別是否太複雜？「太複雜」通常意味著「程式碼讀者無法快速理解」。它也可以意味著「當開發人員嘗試呼叫或修改此程式碼時，很可能會引入錯誤。」


一種特定的複雜度是**過度設計**，開發人員使程式碼更通用，或新增系統目前不需要的功能。評審者應特別注意過度工程。鼓勵開發人員解決他們現在知道需要解決的問題，而不是開發人員推測_未來_可能需要解決的問題。未來的問題應該在它到來並且您可以在物理宇宙中看到其實際形狀和要求時解決。


## 測試 (Tests)[](https://eng-practices.gh.miniasp.com/review/reviewer/looking-for.html#%E6%B8%AC%E8%A9%A6-tests)

根據需求要求進行單元、整合或端對端測試。一般而言，測試應與生產程式碼在同一變更清單中新增，除非該變更清單處理緊急情況。


請確保變更清單中的測試是正確、明智和有用的。測試本身不會測試，我們很少為測試編寫測試 - 人必須確保測試是有效的。


當程式碼錯誤時，測試會實際失敗嗎？如果程式碼在它們下面變更，它們是否會開始產生錯誤陽性？每個測試是否提出簡單有效的斷言？測試是否在不同的測試方法之間適當地分離？


請記得測試也是需要維護的程式碼。 不要因為測試不是主要二進位檔的一部分，就在測試中接受複雜性。


## 命名 (Naming)[](https://eng-practices.gh.miniasp.com/review/reviewer/looking-for.html#%E5%91%BD%E5%90%8D-naming)

開發者為每個東西取了好名字嗎？一個好的名字應該足夠長，以便完全傳達該項目的內容或功能，而不至於太長而難以閱讀。


## 註解 (Comments)[](https://eng-practices.gh.miniasp.com/review/reviewer/looking-for.html#%E8%A8%BB%E8%A7%A3-comments)

這位開發人員是否使用易懂的英文書寫清晰的註解？所有的註解是否都是必要的？通常當註解解釋了程式碼存在的原因時就很有用，而不是解釋程式碼在做什麼。如果程式碼本身並不清晰，那麼就應該簡化程式碼。也有一些例外情況（例如常規表達式和複雜演算法通常受益於解釋其操作的註解），但大多數註解都是提供程式碼本身所不能包含的資訊，比如決策背後的原因。


檢視此變更清單之前的評論可能有所幫助。也許現在可以刪除一個 TODO，刪除建議不要進行此更改的評論，等等。


請注意，註解與類別、模組或函式的_文件_有所不同，後者應表達一段程式碼的目的，如何使用它以及在使用時的行為。


## 風格 (Style)[](https://eng-practices.gh.miniasp.com/review/reviewer/looking-for.html#%E9%A2%A8%E6%A0%BC-style)

在 Google，我們為所有主要的語言，甚至大部分不太常用的語言都有[程式碼風格指南](http://google.github.io/styleguide/)，請確保變更清單符合適當的程式碼風格指南。


如果您想要改進一些風格，但風格指南中沒有提到，請在您的評論中加上「Nit:」作為字首，讓開發人員知道這只是您認為可以改善程式碼但不是必要的細微意見。不要僅基於個人風格偏好而阻止變更清單被提交。


CL 的作者不應包含主要的樣式變更和其他變更。這會使得很難看出 CL 中正在進行的更改，也會使合併和回退變得更加複雜，造成其他問題。例如，如果作者想要重新格式化整個檔案，請讓他們將重格式化作為一個 CL 發送給你，然後再傳送另一個 CL 來進行功能更改。


## 一致性 (Consistency)[](https://eng-practices.gh.miniasp.com/review/reviewer/looking-for.html#%E4%B8%80%E8%87%B4%E6%80%A7-consistency)

如果現有的程式碼與風格指南不一致怎麼辦？根據我們的 [程式碼審查原則](https://eng-practices.gh.miniasp.com/review/reviewer/standard.html#principles)，風格指南是絕對的權威：如果風格指南要求某些內容，這 CL 就應該遵循這些指南。


在某些情況下，風格指南僅是提供建議而非強制規定。在這些情況下，應根據判斷，決定新的程式碼是否應與建議或周圍的程式碼保持一致。傾向於遵循風格指南，除非當地的不一致會太令人困惑。


如果沒有其他規則適用，作者應該與現有的程式碼保持一致性。


無論如何，都要鼓勵作者提交錯誤報告並新增一個待辦事項來清理現有的程式碼。


## 文件 (Documentation)[](https://eng-practices.gh.miniasp.com/review/reviewer/looking-for.html#%E6%96%87%E4%BB%B6-documentation)

如果一個 CL 更改了使用者建立、測試、互動或釋出程式碼的方式，請檢查是否也更新相關的文件，包括 README、g3doc 頁面和任何已產生的參考文件。 如果變更清單刪除或不推薦使用的程式碼，請考慮是否應刪除相關的文件。如果有缺少文件，請詢問相關人員。


## 每一行 (Every Line)[](https://eng-practices.gh.miniasp.com/review/reviewer/looking-for.html#every-line)

通常情況下，應檢視您被指定審查的_每行_程式碼。像資料檔案、產生的程式碼或大型資料結構這樣的東西有時可以掃描，但不要掃描人寫的類、函式或程式碼塊，並假設其中的內容沒有問題。顯然，某些程式碼比其他程式碼更需要仔細檢查 - 這是您必須做出的判斷 - 但您至少應確保您_理解_所有程式碼的運作方式。


如果你發現程式碼太難閱讀而減緩了審查速度，你應該告訴開發人員，在嘗試審查之前等待他們澄清。在 Google，我們招聘優秀的軟體工程師，而你就是其中之一。如果你無法理解程式碼，其他開發人員也很可能無法理解。因此，當你要求開發人員澄清時，你也在幫助未來的開發人員理解這段程式碼。


如果你瞭解程式碼，但是你覺得自己不太適合審查某部分，確保讓這個 CL 有合格的審查者 (參考 : #every-line-exceptions)，尤其是針對隱私、安全性、併發性、可訪問性、國際化等複雜問題。


### 例外情況 (Exceptions)[](https://eng-practices.gh.miniasp.com/review/reviewer/looking-for.html#every-line-exceptions)

如果你需要檢查每一行，但這對你來說不合理，該怎麼辦呢？例如，在變更清單上有多個審查者，你可能會被要求：

- 檢視屬於較大變更的某些檔案。
- 檢視變更中的某些方面，例如高層次設計、隱私或安全影響等。


在這些情況下，請在評論中註明您審查的部分。建議使用 “帶有評論的 LGTM”。


如果您希望在確認其他審查者已經檢查完變更清單的其他部分後給予 LGTM，請在評論中明確註明以設定期望。一旦變更清單達到所需狀態，請[快速回應](https://eng-practices.gh.miniasp.com/review/reviewer/speed.html#responses)。


## 背景說明 (Context)[](https://eng-practices.gh.miniasp.com/review/reviewer/looking-for.html#%E8%83%8C%E6%99%AF%E8%AA%AA%E6%98%8E-context)

通常，在廣泛的背景下檢視變更清單會很有幫助。通常，程式碼審查工具僅會顯示正在更改部分周圍的幾行程式碼。有時您需要檢視整個檔案以確保更改實際上是有意義的。例如，您可能只會看到新增了四行新的程式碼，但當您檢視整個檔案時，您會發現這四行程式碼實際上位於一個 50 行的方法中，現在真正需要將其拆分為較小的方法。

這個 CL 是否提高了整個系統的程式碼健康度，還是讓整個系統變得更複雜、測試程度更少等等？
**不要接受會降低系統程式碼健康度的 CL**。大部分的系統是透過許多累積增加的小變更變得複雜，所以防止新變更中出現任何小的複雜性是很重要的。


## 優秀表現 (Good Things)[](https://eng-practices.gh.miniasp.com/review/reviewer/looking-for.html#good-things)

如果您在 CL 中看到什麼優秀表現，請告訴開發人員，尤其是當他們以出色的方式解決了您的意見中的一個問題。程式碼審查通常只關注錯誤，但它們應該提供鼓勵和感謝好的實踐。從教導的角度來看，告訴開發人員他們做對了什麼事情，有時甚至比告訴他們錯了什麼事情更有價值。


## 概要 (Summary)[](https://eng-practices.gh.miniasp.com/review/reviewer/looking-for.html#%E6%A6%82%E8%A6%81-summary)

在進行程式碼審查時，您應該確保：

- 程式碼設計良好。
- 功能對程式碼使用者很好。
- 任何 UI 更改都是明智的並且看起來很好。
- 任何平行程式設計都是安全的。
- 程式碼沒有比它需要的更複雜。
- 開發者沒有實現未來可能需要但現在不知道需要的東西。
- 程式碼有適當的單元測試。
- 測試設計良好。
- 開發者對一切使用清晰的名稱。
- 註解清晰有用，大多數解釋「為什麼」而不是「什麼」。
- 程式碼適當地記錄（通常在 g3doc 中）。
- 程式碼符合我們的樣式指南。


記得審查**每一行**程式碼，關注其**上下文**，確保**提高程式碼健康度**，並讚揚開發者的**優秀表現**。



ref:
[Fetching Title#lxy4](https://eng-practices.gh.miniasp.com/review/reviewer/looking-for.html)