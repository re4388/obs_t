---
aliases:
  - mileage_feat
  - wemo_mileage_feat
---

- [[_wemo_tickets]]
- [[ceres 重弄到可以跑測試]]
- [[處理 genPaywaysForOrderItems]]
- [[強還建立訂單 2024-05-22 17.43.57.excalidraw
- 還車 card -> notion: https://www.notion.so/nture4388/3806285909374b0baeb0ce9322c4a564?pvs=4
- [PM x RD - TimePlan history](https://docs.google.com/spreadsheets/d/1VlLXlcxe21od6aHBDdp6qd5kSxGaOhHukyi3bNkf0T0/edit?gid=0#gid=0)


- [x] 因為計算價格 vip and non-vip 分開，建議兩個都測試


Ivy1024
userID
201359
ION-0001



stacy
201397
ION-0011
60分鐘
10km


## Test 情境

- ppl not having tp
- ppl have tp with milage setting
- ppl have tp but bought before release -> shall follow original way
- ppl have tp but do not have mileage setting
- 新舊版都要測試

(BE)還車後確認 DB - tpd - 累積 - tpdh - 新建 - chargingDetail - 新建 - order - 新建 - orderItem - 新建, 對齊 chargingDetail

- apollo 改訂單
  - tpd
    - 減掉 "減項", 再加上 rent 那筆的 usedFreeDist
    - "減項" 是該筆 rent 撈出的 tpdh 加總的里程數
  - tpdh
    - 建立一筆"減項"
    - 建立一筆正項，數值為 rent 那筆的 usedFreeDist
  - chargingDetail
    - 新建
  - order
    - 新建
  - orderItem
    - 新建, 對齊 chargingDetail
- apollo refund
  - tpd
    - 減掉 "減項", 再加上 rent 那筆的 usedFreeDist
    - tpdh
      - 新增一筆"減項"
  - order
    - status 調整為 3
    - refundAmt -> 有值, 就是原本的 invoice amt
    - 會有 comment
  - receipt
    - 多一筆, amt 為原本訂單的負值
- apollo 強還建立訂單
  - tpd, tpdh -> 都不會動
  - rent
    - 金額依照 input 調整，多了 orderID
  - order
    - 會多了一筆訂單 (why is paid?)
  - order item (rent, insurance, mileage )
    - 需要增加對應的項目
  - order receipt
    - 新增

---

# Release plan

還車如果 tpd got value for those new col will calculate, and ppl got those value need to buy after be release

Patch do what
Refund and create
Refund do what

- [ ] 系統上線切點和既往不咎事項
- 切點？
  - BE release 後 再買 tp 的人 才會系統處理
- 測例：
  - be release 前買時間方案 還是可以原本的方式操作
    - 原本的方式
    - 上線後買時間方案
- todo

  - talk to stacy

- [ ] why bindOrders test 測不出來
  - [ ]

---

# api study

### test 部分

### POST /v23/users/me/trans

also see [[租還車流程 api, rent, return process]]

```ts fold
POST /v23/users/me/trans HTTP/1.1

table.addAuthEndpoint(5, { method: 'post', endpoint: '/me/trans', controller: OrderController.transV5 })

req.payload
{
  "amount" : 0,
  "isWaiting" : true,
  "orderId" : "20240426121457746",
  "paymentType" : 1,
  "redirectUrl" : "https://wemoscooter.page.link/payment"
}

res
{
  "result" : "success",
  "data" : {
    "orderAmount" : 35,
    "unpaidAmount" : 0,
    "paidAmount" : 35,
    "payways" : [
      {
        "payway" : "creditCard",
        "amount" : 35
      }
    ]
  }
}

```

### update patch DB 的變化

```sh
{
  "rentAt": "2024-05-10T07:02:46.835Z",
  "returnAt": "2024-05-10T07:03:51.534Z",
  "rentAmount": 33,
  "note": "ddd",
  "insuranceStartAt": "2024-05-10T07:02:46.835Z",
  "insuranceEndAt": "2024-05-10T07:03:51.534Z",
  "minutes": 10,
  "distInMeter": 1000
}
```

rent
![[IMG-小時租里程費退款和調整訂單-20241003104923409.png]]

why 3 to 40?
40 is 33 + 3(保險) + 4(milage)
![[IMG-小時租里程費退款和調整訂單-20241003104923843.png]]

tpd
![[IMG-小時租里程費退款和調整訂單-20241003104924053.png]]
to
![[IMG-小時租里程費退款和調整訂單-20241003104924152.png]]
106000-35000=71000
35000 就是算出來的負項 (rentID 下 tpdh 的加總 \* -1)
第二次的 addTimePlanDetailHistory 呼叫，因為 remainingFreeDistInMeter = 0 -> 因此 += 0 -> 沒有變化

多兩筆，一筆是本來加總的負項，一筆是 input 上面的那個 min ![[IMG-小時租里程費退款和調整訂單-20241003104924243.png]]

- rent 上的 orderId 也會改, price 也會調整

tpdh
![[IMG-小時租里程費退款和調整訂單-20241003104924328.png]]
to
![[IMG-小時租里程費退款和調整訂單-20241003104924421.png]]

- 多了兩筆
  - 一筆是加總的減項
  - 一筆是 input 的
    - 因為 input 1000 大於 0 -> 選 0 因為因此沒有剩餘的 dist

order

- 建立新 new
- old oder:

  - status change to 3
  - 還會有 refund amt
  - comment 會兩個都上

  old
  ![[IMG-小時租里程費退款和調整訂單-20241003104924518.png]]
  new
  ![[IMG-小時租里程費退款和調整訂單-20241003104924598.png]]

orderItem

- 建立"一組"orderItem
- 4, 3, 33 對應到我們 patch 的 payload
- 4 is 3.5 \* 1km, then mail.ceil
- 3 is 保險
- 33 is input rent amt
  old
  ![[IMG-小時租里程費退款和調整訂單-20241003104924681.png]]
  new
  ![[IMG-小時租里程費退款和調整訂單-20241003104924769.png]]

receipt 會新增兩筆
old
![[IMG-小時租里程費退款和調整訂單-20241003104924894.png| 500]]
new
![[IMG-小時租里程費退款和調整訂單-20241003104925105.png|500]]

- 新增一筆負項的 with old OrderId
- 新增一筆新的價格 40, 33+4+3

- maybe ask Josh
  - [ ] use paidAmount

## local 租還車的測試前置作業 -> 測試 patch 不需要下面的操作

- 需要手動 comment 掉的地方才可以 local 測試還車
- 確定 scooter 上線 → QAT-0002 每一次都要自己弄上線

```bash

# 改 ceres path -> 如果連不上 ceres 的話
repositories/ceres/ordersV4.ts:20
const res = await axios.post(`http://192.168.2.21:3001/v4/orders`, arg)


## reserve and rent

# coment reserve 的租車zone
api/v2/users/service/rents/reserve.ts:113


# comment isZone 相關的
api/v2/users/service/rents/rent.ts:125

# comment validateUserEvent
api/v2/users/controller/rents.ts:204


## return
#改 ride dist
api/v2/users/service/rents/return.ts:81

# calculateConsumedMinutes 先 fake
api/v2/rents/service/createTimePlanDetailInfo.ts:30

# comment validateReturn
api/v2/users/service/rents/return.ts:90


# payment error -> 讓你沒付款繼續 rent
api/v2/users/service/rents/reserve.ts:91
api/v2/users/service/rents/rent.ts:103


```

## 主要邏輯

- patch [https://apollo-qat.wemoscooter.com/hermes/v17/rents/2463069](https://apollo-qat.wemoscooter.com/hermes/v17/rents/2463069)
  - `controller: controller.patchByIdV17`
  1. 撈資料和組資料
  - selectById by rentId 撈出 rent, user, tpdh
  - `bindOrders` 把上面撈出的也加上 order 資料
    - `zipRentOrderDetailV2`
      - `calOrderDetails` 算出是用哪一種 payway, 然後也標註有沒有付款
      - `genPaywaysForRentAndInsurance` → 把上面的 payway, 根據不同的 charging detial 組起來

2. 退款部分

- `refundOrder`
  - 就是呼叫 ceres 做 refund
- `refundMinutes`
  - 用 rentId 撈出 tpdh (consume 和 refund type) 加總 `usedFreeMinutes`
  - 呼叫`addTimePlanDetailHistory`
    - 加總 `usedFreeMinutes` 的作為負項，update tpd and create tpdh
    - 要 update 的 tpd id 為撈出的可能 multiple 的 tpdh 中的抓一個來 update → 就會是 rent 的 那一筆 tpd
    - create tpdh 的 type 為 refund

3. 建立新訂單部分

- `updateChargingDetailsAmount`
  - 先撈出 `elderDetails`
  - 拿出 rentAmount, insurence and mileage
  - 改為 req 帶入的金額
  - 這邊會把舊的押上 delateAt 的時間，然後建立新的 charginDetail with new amt
- `createNewOrder`
  - 建立新訂單
  - `addTimePlanDetailHistory`
  - `classifyRentChargingDetails`
  - 呼叫 ceres v4 order 打過去
- 也會 update rent ID 的 orderId
- create replaceOrder

*

# archive

### credit 調整

- [x] 看懂 ceres 的邏輯
  - 這段 code 是關鍵吧！ `protected async payByOrderItems(order: { orderItems: Ord`
- [x] 調整 order
- [x] 如果不需要改，要很肯定。

[[thoughts_on_code on time plan]]

## 一些釐清和問題

- 訂單修改上的"Time" 和強還建立訂單上的那個 Time, 就是那個 rent 訂單的 tpdh 的 usedFreeMin, fetch from tpdh
  - 這個 Time 是前端要自動帶上提供的
  - 另外里程費的邏輯上，也會是需要前端自動帶上，然後是 tpdh 的 usedFreeDistInMeter
- [x] order 和 order detail, receipt 的關係?
  - rent 後，會打 trans → trans 會建立 order and receipt
- [x] who use bindOrders?
  - get v2/rents → 2 萬次 by mgmt
  - get /v2/rents/replaced-orders → 1 萬多次 mgmt
  - patch /v17/rents/:id(\d+)$ → 上千次
  - ~~patch /v2/rents/:id(\d+)$ → 2021/10 月都沒使用記錄~~
- [x] e2e test 需要測試，當你沒有 milage 時，後續 fn 可以 handle 嗎？
  - 因為目前如果沒有 insurance, 就會給 undefined → 要改的話應該不難，就跟 insurance 的作法 default 給 undefined 即可
  - 目前先都上 undefined, 跟 insurance 邏輯對齊
- [x] bind order 從 order item 拿到的 amt 是 amt or paid amt or invoice amt?
  - 因為我會用 orderItem 去拿跟來 receit 對，因此我應該要拿 paidAmt

## side effect?

- [ ] josh → corn job 會掃 order = 0 → have side effect?
- [ ] 有空可以想一下這個 local 跑起來 的 error

```bash fold
=====> getOrders::data: {"result":"success","data":[{"amount":7200,"userId":"201212","details":[{"id":"1615911","amount":7200,"payway":"creditCard","cardLast4digits":"4242","cardType":"Visa","createdAt":"2024-05-08T07:07:58.546Z"}],"id":"20240508150757399","status":"paid","createdAt":"2024-05-08T07:07:57.413Z","comment":"ben.hu: created. XXXX","invoice":null,"rentId":0,"type":0,"timePlanDetailId":null,"userVipDetailId":null,"paymentType":1,"ceresUserId":"933600","extendData":{}}],"meta":{"total":1}} =====> getOrders::data: {"result":"success","data":[{"amount":7200,"userId":"201212","details":[{"id":"1615911","amount":7200,"payway":"creditCard","cardLast4digits":"4242","cardType":"Visa"}],"id":"20240508150757399","status":"paid","createdAt":"2024-05-08T07:07:57.413Z","comment":"ben.hu: created. XXXX","invoice":null,"rentId":0,"type":0,"timePlanDetailId":null,"userVipDetailId":null,"paymentType":1,"ceresUserId":"933600","extendData":{}}],"meta":{"total":1}} 2024-05-08T07:07:59.131Z error: "{\n tag: 'api/v2/points/service/index/_onOrderPaidAddPoint',\n error: { message: 'Find 0 rents with rentId: 0, which should never happen' },\n xRequestId: 'b3645ae0-0d09-11ef-b169-51533e9f7584'\n}" Error: Find 0 rents with rentId: 0, which should never happen at /Users/re4388/project/work/Hermes-poc/api/v2/points/service/index.ts:110:15 at Generator.next (<anonymous>) at fulfilled (/Users/re4388/project/work/Hermes-poc/api/v2/points/service/index.js:5:58) at processTicksAndRejections (internal/process/task_queues.js:97:5)
```

---

- ~~使用者畫面下打取消~~
  - ~~[https://apollo-qat.wemoscooter.com/hermes/v14/timePlans/details/2756?refundAmount=349&reason=qqq](https://apollo-qat.wemoscooter.com/hermes/v14/timePlans/details/2756?refundAmount=349&reason=qqq)~~
  - ~~取消 tpd~~
    - ~~export const deleteTimePlanDetailById: WeMoRouter~~
    - ~~這邊應該不用改~~

## backup or ref code

classifyRentChargingDetails

```ts fold

export const classifyRentChargingDetails = (chargingDetails: { id: string; description: string; amount: number; defaultInvoiceAmount?: number }[]) => {
  const rentDetail = chargingDetails.find((d) => d.description === DefaultRentChargingDescription.ride)
  const insuranceDetail = chargingDetails.find((d) => d.description === DefaultRentChargingDescription.insurance)
  return { rentDetail, insuranceDetail }
  const mileageDetail = chargingDetails.find((d) => d.description === DefaultRentChargingDescription.hourlyPlanMileageFee)
  return { rentDetail, insuranceDetail, mileageDetail }
}
```

use floorToDigit 算 chargedDistInMeters

```ts fold

if (isTimePlanFreeDistEnable(tpd) && rideDist > 0) {
  const rideDistInMeter = floorToDigit(rideDist, 1) * 1000
  // 累加後里程 = 累加前里程 + 本次騎乘里程
  const usedFreeDistInMeters = tpd.usedFreeDistInMeters! + rideDistInMeter
  tpdInfo.usedFreeDistInMeters = usedFreeDistInMeters

  let chargedDistInMeters = 0
  let chargedDistFee = 0

  // 如果免費里程 > 累加前里程
  if (tpd.totalFreeDistInMeters! > tpd.usedFreeDistInMeters!) {
    // 累加後里程 > 免費里程 -> 收取超出部分里程的費用
    if (usedFreeDistInMeters > tpd.totalFreeDistInMeters!) {
      chargedDistInMeters = usedFreeDistInMeters - tpd.totalFreeDistInMeters!
    } else {
      // 累加後里程 <= 免費里程 -> 收不需要收費
      chargedDistInMeters = 0
    }
  } else {
    // 免費里程 <= 累加前里程 -> 全部里程收費
    chargedDistInMeters = rideDistInMeter
  }

  // 收費無條件到整數
  chargedDistFee = Math.ceil(floorToDigit(chargedDistInMeters / 1000, 1) * tpd.ratePerKm!)

  tpdInfo.chargedDistInMeters = chargedDistInMeters
  tpdInfo.rideDistInMeter = rideDistInMeter
  tpdInfo.chargedDistFee = chargedDistFee

  logger.debug({ tag, usedFreeDistInMeters, chargedDistInMeters, chargedDistFee })
}

```

- [ ] table.addAuthEndpoint(17, { method: 'post', endpoint: '/:id(\\d+)/order', controller: controller.postOrderV17 }) 這個 API 誰在用? 裡面的 update Charing detial 這次需要調整嗎？

  - [ ] 會需要調整，這個就是 強制還車裡面的建立訂單 -> 另一個卡需要調整

- [ ] ceres 扣款那邊也要 sorting 比較好

### 強還建立訂單

建議實作方法 - 強還時不計算 tp 相關資料 - 強還時不計算 charginDetail 相關資料 / 訂單資料 - BE 實作 - 強還 API - 不需要調整 - 強還建立訂單 - 小調 - 顯示 freeDist, usedFreeDist and rideDist

why?

- 符合目前分鐘數的強還邏輯 -> 不會建立訂單資料，不會記錄時間方案的資料, 強還建立訂單時會處理金額

- 如果要計算 tp 相關資料

  - 尷尬的點是，分鐘數就沒有這樣做，因此這樣會讓資料和邏輯都不一致
    - 就是同一個表中，分鐘數不會因為強還而調整，但里程費會
    - 邏輯上，要因為分鐘數和里程費要方開處理 -> 但他們都是在 timeplan 的表上，目前都是一起處理。

- 如果要建立 chargingDetail, order 等資料

  - 強烈不建議，因為這會改變目前強還不建立訂單相關資訊的既有邏輯和設計，牽涉到金流那邊的 code 的資料和邏輯一致性

- 需要討論的點

  - 方法 1,2,or 3?
  - 強還已經不是使用者還車了，是 WeMo 方 還車，依照這邊去計算的 ride distance 來估算金額是否有爭議?
    - 建議不收里程費 (系統還是可以讓 CS 輸入，但是建議 web 上給 0 as default)
  -

- to Clarence

  - 要顯示 ride distance , 顯示方案?, freeDist and usedDist

- ~~方法一：~~

  - ~~強還時不計算 tp 相關資料~~
  - ~~強還時加入 charginDetail 相關資料 / 訂單資料~~
  - ~~BE 實作：~~
    - ~~目前分鐘數不是這樣處理（就是不會強還不會建立 tp 相關資料） -> 因此強還建立訂單那邊還是需要調整特化~~
    - ~~目前強還也不會去呼叫 ceres, 建立訂單相關資料因此 -> 變得需樣強還去建立 order item, 建立 order~~
    - ~~不建議，跟目前機制不一樣~~

- ~~方法二：~~
  - ~~強還時計算 tp 相關資料~~
  - ~~強還時不計算 charginDetail 相關資料~~
  - ~~BE 實作~~
    - ~~目前分鐘數不是這樣處理（就是不會強還不會建立 分鐘數 相關資料）-> 因此強還建立訂單那邊還是需要調整特化~~~~

### force return 要如何做？

- 那個畫面會呈現什麼? 自動算是什麼意思?
- 正流程會做的事情，force ret 都要做

  - 算里程相關的東西
  - 然後後面會寫入 tp and tpd
  - 應該是不需要建立訂單那一個部分
  - [ ] write into tp and tpd, but min 這部份不會記入，這樣 okay?
  - 強還建立訂單那個畫面
    - 要把上面這些拉出來顯示
    - 然後建立訂單的部份
      - 應該會需要有 chrging detai, order, order item 這些部分
      - [ ] 這邊需要 check order creation 在強還那邊建立需要的跟正流程的畫面的函數是同一個?

- 思考 why 我們要組
  - [[rent_receipt_item.excalidraw]]
