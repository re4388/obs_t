[[_network_idx]]


### 三種代理模式
- [【进阶•代理模式篇】看懂就能解决99%的代理问题，详解系统代理、TUN/TAP代理、真VPN代理，clash/v2ray/singbox 虚拟网卡怎么接管系统全局流量](https://www.youtube.com/watch?v=qItL005LUik)
    - 網路傳輸過程
        - client : http內容 封裝 tpc/dup, 封裝 ip, 封裝 mac
            - client local 有 網關可以找到 router
                - client 第一次連上LAN透過廣播讓 router 知道
                    - router 透過 dhcp服務分配一個ip, 網關ip(就是router的ip) 和 dns ip(通常是router ip)
        - router 解到 ip 層，看到 private ip, 透過其 nat 表，轉為pub ip
        - 經過很多路由
        - 最後到server 解包: 解 mac, 解 ip, 解 tcp/dup, 解 http 看到 req 內容
        - server 發 response, 類似上面過程
    - 三種代理
        - 系統代理 → 透過軟體
        - tun/tap → 透過虛擬網卡接管網路
        - 真 vpn
    - 系統代理
        - 安裝代理軟體，類似 v2Ray, clash 等
        - 看是用哪種協議(類似 ss, shadow socket)，然後就是把內容加密包一層，然後再往外傳，流程一樣
            - 封裝: 內容透過客戶端代理加密→ http內容 封裝 tpc/dup, 封裝 ip, 封裝 mac
            - 會傳到代理節點（就是支援那個協議的節點）→ 再傳到目的地
            - 原路傳回來, 客戶端代理解密
        - 優點：單純
        - 缺點
            - 需要 軟體支援，類似瀏覽器可以設定代理(firefox foxy等, curl 可以加 tag等等)
            - 因此很多其他沒支援的就無法用了，類似很多遊戲和網路應用就沒有預設代理可以選。
    - tun 代理 (網路層)
        - tap 是 封裝 mac 層 → 基本上對這邊沒有太多用處，不需要, 這邊主要說 tun
        - how?
            - 在路由表建立路由規則 let all ip use its 虛擬網卡
            - Then use physical 網卡 to go out
        - 透明代理的意思?
            - tun 裝在 router/軟路由, 其他電腦透過這台軟路由上網，因此對其他電腦來說，這個代理是透明看不到的。
            - 軟路由也可指可以改動的路由器, 軟體路由
        - 常見 tun 代理：clash, SSTap, Netch, sing-box, v2RayN6.0以上
        - 有v2RayN6.0 window操作說明
        - 缺點? 沒有代理全部的網路層protocol，icmp沒有封裝, ping 的回應是假的
    - 真vpn
        - 不只是協議，是一組技術的實現
        - 可以封裝整個網路層的數據包
        - wireguard, pptv, ipsec, openVPN, tailscale
        - 可以實現異地組網，內網穿透
        - 可以實現”虛擬”的讓你我他在一個內網裡面
        - 缺點?
            - 不是為了翻牆而生
            - 可以對數據加密，因此gfw 不知道what u send
            - but vpn 流量 但容易被識別
	            - so vpn 跟那些刻意隱藏自身流量特徵的翻牆協議不同
            - 分流不方便，不方便科學上網
                - 科學上網需要分流，去中國不走代理，去外面要走代理



## DNS 洩漏是什麼
- [【进阶•DNS泄漏篇】](https://www.youtube.com/watch?v=fqREM6b25SY&t=533s)
    - 哪裡有 dns cache
        - 瀏覽器, OS, router, 路由上層的dns, 一直到權威server 都有 cache ttl
            - 家裡瀏覽器和OS cache 找不到或是 ttl expire 才會發包往外找
            - like `/etc/hosts`
            - `scutil --dns
    - 查哪些 dns server 幫我們查
        - [https://ipleak.net/](https://ipleak.net/)
        - 這個網站會 gen randomID發 dns 請求，然後記錄下來，因此就可以定位我們的 location
        - 這邊可以看到的dns server 是上(or 上上 or 上上上)游的那些 ns server
	        ![[IMG-不良林-代理进阶篇-20241106203159150.png]]


    - DNS 洩漏是指，翻牆時，透過代理時…
        - 架設你要連到 google, 你如果需要查 DNS
        - 那除非你有加密 or use DoT or DoH, 不然就是明文的
        - 那你傳出去每一層的路由都知道你要查 google, 那你翻牆的意圖就洩漏了
        - 你要查 google IP, 又加密，誰都知道你在翻牆，官方直接 ban 節點
        - nextflix 也可以發給 clinet 一個 dns req, 然後看看 dns 上游server的 ip 和你發過來的節點 server ip 比對，如果不同地區，判斷你用代理不給看
        - 解法？
            - 本地不要發 DNS請求！讓節點發（已經在牆外了）, 加密的數據要已經包含域名
            - 需要針對客戶端去進行對應的設置 → 結論就是要下規則不要去發 DNS 請求
    - 瀏覽器的 webRTC 洩漏
        - [WebRTC Leak Test - BrowserLeaks](https://browserleaks.com/webrtc)



## fakeIP, fakeDNS 技術

- [(402) 【进阶•DNS分流篇】提速降延迟！保护个人隐私，彻底弄懂DNS泄漏，让DNS分流不再玄学，详解DNS污染、DNS劫持在透明代理中的行为，redir-host问题太多已成历史，fake-ip成功上位 - YouTube](https://www.youtube.com/watch?v=aKlH6KRt9Jc&list=PL5TbbtexT8T3JJdJAy73A0T2NXZL2JEJY&index=3)


- 主要都在講上面的配置, 規則模式, 要怎麼配置才不會dns 洩漏和污染
	- 依照 domain, domain的 surfix, keyword
	- 依照 源 ip cidr
	- 直連, 就是不走(系統)代理
	- no-resolve 表示不會dns解析 → 那如果自己發 dns請求就洩漏了, 如果被污染的話那就連不到了
    - fakeIP, fakeDNS 機制
        - 系統代理會劫持瀏覽器的dns 請求，返回一個假的ip給瀏覽器
        - 然後系統代理自己有一個mapping 表 域名↔fake_ip, 因此代理知道你要去那個域名
        - 系統代理用那個域名傳出去，節點那邊才是真的dns請求的地方
        - 這樣本地不會發dns請求，因此沒有 dns leak的問題
        - 壞處是有時候會怪怪的
            - 可能是電腦OS這邊還是會去看到那些fakeIP, 因此導致類似你跑的好好的，但電腦的網際網路那邊顯示網路異常，這是因為系統用你的fakeIP自己也有去做解析然後解不到
            - 另外就是有時候如果系統自己幫你解析還幫你cache, 那就有可能出問題


## fake IP 怪怪的 →  用流量嗅探sniffing 拿真實IP
- [【进阶•DNS代理篇】最完美的DNS解决方案？通过代理DNS请求获取正确的ip，杜绝DNS泄露和DNS污染，解决透明代理下fake-ip存在的问题，开启sniffing流量嗅探亦可解决污染问题 - YouTube](https://www.youtube.com/watch?v=50iVDmqzDW8&list=PL5TbbtexT8T3JJdJAy73A0T2NXZL2JEJY&index=4)
    - v2ray的 config知識
        - innbounds決定哪些東西可以進來
        - 然後進入路由，路由的 rule 一個一個看
        - 最後到 outbound
        - 例子：
            - 瀏覽器發 dns/http請求，進入 127.0.0.1 的proxy的10808 port, 透過 socks 協議
            - 然後路由規則會看
                - 裡面包括看 geosite 和 geoip資料看
                - 類似第二個規則，如果是大陸的ip, 就沒必要走代理了，直連
                - 然後會決定 outbound 的 tag
            - 最後對到的 outbound tag 決定用那個路由
                - 類似代理走 ss, block tag就走 blackhole(丟棄)
        - 這個系統代理沒有 dns 模組
	        ![[IMG-不良林-代理进阶篇-20241106203159391.png|300]]
        - ipIfNonMatch: 第一次跑看域名，第二次會解析後再次批配
	        - “Asls"：只使用域名进行路由选择。
	        - "IPOnDemand"：当匹配时碰到任何基于 IP 的规则将域名立即解析为 IP 进行匹配。
	        - IPIfNonMatch"：当域名没有匹配任何规则时将域名解析成 IP再次进行匹配。
        - 作者建議用繞過大陸模式，這樣就不會產生本地發 dns → dns leak
    - 軟路由，就是透明代理，跟上面不同的是有 dns module
	    ![[IMG-不良林-代理进阶篇-20241106203159718.png]]
    - 比較複雜
    - inbound → route 策略/規則 → 可以設定哪一個dns ip by 哪一種 domain的請求 → outbound
    - dns 是 udp, 然後 outbound 那邊又包成 tcp based 的 vmess → udp over tcp, 就是外面又包了一層 tcp 再出去 → no dns leak → 節點那邊做dns
    - assume 下面的 路由規則設定錯了，你用成直連，這樣你就沒走代理, dns leak and dns 污染 → 然後你要發 http 請求，因為 代理有開啟流量sniff功能，會看 sni, 因此會知道你要去的域名，[像是google.com](http://xn--google-2q1jg37l.com), 會幫你進行 dns lookup, 因此你還是會拿到正確的google的網頁
        - 就算你代理忘記開，節點那邊很多時候都會開啟這個流量嗅探的功能，因此也還是可以幫你正確訪問google
        - 這就相對於fakeIP就是會真的本機可以拿到真的ip
    - 用fake ip 還是用這個就看你的情境
        - 看你會不會因為fake ip 導致使用上異常 → 會的話用真實ip
        - 看你會不會因為每次都要打拿真實dns都導致速度變慢 → 會的話用fake ip
        - 都不會就沒差


## UDP, fullcone全椎, 對稱

- [(402) 【进阶•UDP穿透篇】WebRTC泄漏真实IP、搭建游戏节点必看的UDP代理知识！原生UDP和UoT的区别，P2P联机UDP打洞，实现游戏最佳的fullcone，为什么QUIC会导致youtube降速 - YouTube](https://www.youtube.com/watch?v=GQg5JIQIjgk&list=PL5TbbtexT8T3JJdJAy73A0T2NXZL2JEJY&index=5)

- webRTC leak
    - 測試網站是透過 stun [https://browserleaks.com/webrtc](https://browserleaks.com/webrtc)
    - 會回傳 pub ip, 因此這邊存在leak
    - clash 全局不會 take care stun, 因此就直連了，因此就 leak了
    - but socket5 是支持 udp 的，但因為瀏覽器不支持將udp交給socket5(clash)代理, 因此就直連
    - 目前可以解這個 dns leak只能是用browser ext 禁用 webRTC 功能
    - 如果用軟路由走 tun mode, 用 虛擬網卡接管的話，那 udp就會進入代理 → 那就是會被加密傳出去了 → 也是一個解法
        - 影片中，作者也要把client 開啟udp支援，節點也要開啟 udp代理才可以work
    - 另外用其他vmess 等也是可以，就是 udp加密再包上tcp, udp over tcp (uot)
- udp over tcp 比較好？
    - 線路比較差的VPS，有些運營商會先檔udp, 讓 tcp 先過(因為udp沒有壅塞控制，因此先卡這個不手規矩的XD)
    - 缺點就是變成了 tcp, 需要握手等，封包丟了需要補等等，延遲敏感的gaming 場竟就不適合
- gaming 中的 p2p
    - 一種是中心式, udp可以通就可以玩
    - 一種為p2p, 大家互相都連在一起, ps2, xbox, switch 等等都是這種, bt
    - webRTC 也是需要用 stun
	    ![[IMG-不良林-代理进阶篇-20241106203159802.png]]

- 如果你router就可以拿到公網ip, 那你就有機會修改 router nat 的映射和過濾行為來達到 全椎 full-cone (最好打洞的) 
	- more see [[How NAT traversal works#介紹NAT分類]]
		![[IMG-不良林-代理进阶篇-20241106203200132.png]]
- full cone → fw and nat 都是獨立
    - 獨立就是換了目標ip, nat/fw不會也另外配一個新的私部ip → 沒關係
- 遊戲中的說法：開放, 類型1 or A
	![[IMG-不良林-代理进阶篇-20241106203200240.png|967]]
	
- 更多情況是如下, 雙層 nat
	- 你根本無法摸到外面運營商那邊的nat去進行調整
	- 然後這邊的 nat 也是對稱 nat → 就是 fw and nat 都不獨立，最難搞
		![[IMG-不良林-代理进阶篇-20241106203200676.png| 300]]
	- 對稱nat 沒髮夾, 又沒開放port mapping protocol, 大概就只能靠中繼server了 => 速度慢且不穩定
		![[IMG-不良林-代理进阶篇-20241106203200819.png|400]]
	- 對於科學上網來說， turn 就是節點了
	- 因為可以拿到公網ip → 搭配軟體配合, like xRay → easy to 實現 fullcone 
		- [https://github.com/XTLS/Xray-core/releases/tag/v1.3.0](https://github.com/XTLS/Xray-core/releases/tag/v1.3.0)
	- check NAT 類型: [https://github.com/HMBSbige/NatTypeTester](https://github.com/HMBSbige/NatTypeTester)
		- 作者接著顯示如何用客戶端的配置搭配NAT檢查，然後選有支持fullcone節點的去找哪些連接有 fullcone


- http3基於 quic, quic 基於 udp
    - 一些影音的網站，like yt等都有很多http3的資源了
    - 第一次發http2, server 會回說，可以用http3喔, so 瀏覽器接著就會用 http3訪問
    - 但是上面說過，如果你有用系統代理，但瀏覽器不支持將udp交給代理, 因此瀏覽器會關閉quic, 會用http2
    - 但是如果用透明代理，clash會直接發起 dns 請求（redir-host mode） → dns 洩漏和污染
        - 如果有開啟 sniffing, 可以避開污染
        - 但是因為用 udp, 還是會有上面說的很卡的問題
            - 因為不好的線路原生udp會被優先檔
            - 用udp over tcp 也會影響性能
    - 解法? → 瀏覽器 disable quic
	    ![[IMG-不良林-代理进阶篇-20241106203201499.png]]


## v2rayA
[https://v2raya.org/en/docs/prologue/installation/debian/](https://v2raya.org/en/docs/prologue/installation/debian/)
```bash
wget -qO - <https://apt.v2raya.org/key/public-key.asc> | sudo tee /etc/apt/keyrings/v2raya.asc

echo "deb [signed-by=/etc/apt/keyrings/v2raya.asc] <https://apt.v2raya.org/> v2raya main" | sudo tee /etc/apt/sources.list.d/v2raya.list
sudo apt update

sudo apt install v2raya v2ray ## you can install xray package instead of if you want

sudo systemctl start v2raya.service
sudo systemctl enable v2raya.service

# gcp上要記得開這個 port
<http://35.229.134.225:2017/>
```